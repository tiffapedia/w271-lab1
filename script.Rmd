---
title: "Lab 1 Script"
author: "Robert Deng, Tiffany Jaya, Shan He, Joanna Huang"
output: 
  pdf_document:
    latex_engine: xelatex
  toc: true
  number_sections: true
fontsize: 11pt
geometry: margin=1in
---

# Code 0: load packages and dataset

```{r}
# add packages
library(ggplot2)
library(knitr)
# prevent source code from running off the page
opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=TRUE)
# remove all objects from current workspace
rm(list = ls())
# load data
d <- read.csv("./dataset/challenger.csv", header=TRUE, sep=",")
```

# Code 1: (TODO: eda)

```{r}
summary(d)
describe(d)
ggplot(d, aes(x = Temp)) + geom_histogram(binwidth = 3)

# list rows of data that have missing values 
d[!complete.cases(d),] # no missing values

```

# Code 2A: plot figure 1, joint temperature versus number of O-rings failure incidents

##  Using plot

```{r}
plot(main='Joint Temperature vs Number of O-rings Failure Incidents',
     x=d$Temp, xlab='Temperature (F)', xlim=c(50,80),
     y=d$O.ring, ylab='Number of O-rings Failure', yaxt='n', 
     panel.first=grid(col="gray", lty="dotted"), pch=20)
abline(h=0)
axis(side=2, at=0:2)
```

## Using ggplot (TODO: add abline at 0 and format y-axis to show whole numbers)

```{r}
ggplot(d, aes(x=Temp, y=O.ring)) + 
  geom_point() + 
  labs(title = 'Joint Temperature vs Number of O-Rings Failure Incidents', 
       x='Temperature (F)', y='Number of O-rings Failure') 
```

```{r}
# + theme(plot.title = element_text(lineheight=1, face="bold", color = "darkred"))
```

# Code 3: (TODO)

```{r}
ggplot(d, aes(x=Pressure, y=O.ring)) + geom_point() + 
  labs(title = 'Joint Pressure Versus Number of O-Ring Failures', y='Number of O-ring failures', x='Pressure (psi') + 
  theme(plot.title = element_text(lineheight=1, face="bold", color = "lightseagreen")) 
  
d %>%
  ggplot(aes(x = factor(O.ring), fill = factor(O.ring))) +
  geom_bar() +
  facet_wrap(~Pressure) + 
  labs(title = 'Count of O-Ring Failures at Pressure Levels', y='Count', x='Number of O-ring failures') + 
  theme(plot.title = element_text(lineheight=1, face="bold", color = "lightseagreen")) 
```



# Code 4A: linear regression model 

```{r}
l1 <- lm(formula = O.ring > 0 ~ Temp,
        data = d)
summary(l1)
```

```{r}
predict(l1, data.frame(Temp = 31), type='response')
```

```{r}
plot(d$Temp, d$O.ring, pch = 20, 
     xlab="Temperature (F)", ylab="Number of O-Ring Failures")
abline(reg=l1, col = "red", lwd = 2)
l1.predict <- predict(l1, data.frame(Temp=x), interval="predict")
lines(x, l1.predict[,2], lty=2, col="red")
lines(x, l1.predict[,3], lty=2, col="red")
```

# Code 5A: binary logistic regression model 


# Code 5B: hypothesis of binary logistic regression model 


# Code 6A: binomial model 

We apply the logistic regression model to model the probability of the O-rings failure at various temperatures.

$$\begin{aligned} 
P(Y_i = 1 | x_i) = \frac{e^{\beta_0 + \beta_1 x_i}}{1 + e^{\beta_0 + \beta_1 x_i}} = \pi_i 
\end{aligned}$$

$i$: observation for a single launch
$Y_i = 1$: failure launch, at least one O-ring failure
$Y_i = 0$: successful launch, no O-ring failure
$x_i$: outside temperature in degrees Fahrenheit

# Code 6B: hypothesis of binomial model 

$H_0: \beta_1 = 0$

$H_a: \beta_1 \ne 0$

Null Hypothesis: outside temperature has no effect in O-rings failure

Alternative Hypothesis: outside temperature has an effect in O-rings failure

# Code 6C: fitting the model

```{r}
bm0 <- glm(formula = O.ring > 0 ~ 1, 
          family = binomial,
          data = d)
bm1 <- glm(formula = O.ring > 0 ~ Temp, 
          family = binomial,
          data = d)
summary(bm1)
bm1.b0 <- bm1$coefficients[1]
bm1.b1 <- bm1$coefficients[2]
```

$$\begin{aligned}
P(Y_i = 1 | x_i) & = \frac{e^{\beta_0 + \beta_1 x_i}}{1 + e^{\beta_0 + \beta_1 x_i}} \\
                 & \approx \frac{e^{15.0429 - 0.232 x_i}}{1 + e^{15.0429 - 0.232 x_i}} 
                 = \hat{\pi_i}
\end{aligned}$$



# Code 6D: Likelihood Ratio Test (LRT) to determine if Temp was a statistically significant addition to model

```{r}
#pchisq(-2 * (logLik(m0) - logLik(m1)), df=1, lower.tail=FALSE)
anova(m0, m1, test="Chi")
```

# Code 6E: concluding remakrs about binomial model 

With p-value = 0.0320, there is enough evidence to reject the null hypothesis and conclude that outside temperature has an effect in o-ring failure.

## p-value

With p-value = 0.0320, there is enough evidence to reject the null hypothesis and conclude that outside temperature has an effect in o-ring failure.

## Interpret the main result of your final model in terms of both odds and probability of failure.

### 1. odds

```{r}
# for every 1 F increase, odds of the o-rings failing decreases by a factor of 
exp(m1.b1)
# for every 1 F decrease, odds of the o-ring failing increases by a factor of 
exp(-m1.b1)
```

For every 1 degree Fahrenheit increase in temperature, the odds of the O-rings failing for a given launch decreases by a factor of 0.79. 

For every 1 degree Fahrenheit decrease in temperature, the odds of the O-rings failing for a given launch increases by a factor of 1.26. 

```{r}
# for every 1 F increase, odds of the o-rings failing decreases by ... % 
100 * (exp(m1.b1) - 1)
# for every 1 F decrease, odds of the o-rings failing increases by ... % 
100 * (exp(-m1.b1) - 1)
```

For every 1 degree Fahrenheit increase in temperature, the odds of the O-rings failing for a given launch decreases by 20%. 

For every 1 degree Fahrenheit decrease in temperature, the odds of the O-rings failing for a given launch increases by 26%. 

### 2. probability of failure

Since the Challenger shuttle was launched at 31 F, the proability of O-rings failing based on our logistic regression model is approximately $\hat{\pi_i} \approx 0.99.$

```{r}
predict(m1, data.frame(Temp = 31), type='response')
```

If they have waited until 53 F as suggested, the probability of O-rings failing based on our logistic regression model is approximately 0.94. 

```{r}
predict(m1, data.frame(Temp = 53), type='response')
```

This would have decreased the odds of a failure by a factor of 0.006. 

```{r}
# If launched at 53 F instead of 31, it would have decreased odds of failure by a factor of
exp(m1.b1  * (53 - 31))
```

# Code 2B: plotting figure 4, joint temperature versus number of O-rings failure incidents with binary and binomial model

## Using plot

```{r}
plot(main='Joint Temperature vs Number of O-rings Failure Incidents',
     x=d$Temp, xlab='Temperature (F)', xlim=c(50,80),
     y=d$O.ring, ylab='Number of O-rings Failure', yaxt='n', 
     panel.first=grid(col="gray", lty="dotted"), pch=20)
abline(h=0)
axis(side=2, at=0:2)
curve(exp(bm1.b0 + bm1.b1*x)/(1 + exp(bm1.b0 + bm1.b1*x)), 
      from = min(d$Temp),
      to = max(d$Temp), 
      add = TRUE)
```



# Code 8 

```{r}
lp.31 <- predict(object = m1, newdata= data.frame(Temp=31), type = 'link', se = TRUE)

lp.31.pred <- lp.31$fit 
lp.31.lin.pred.lower <- lp.31$fit - qnorm(p = 1-0.05/2) * lp.31$se
lp.31.lin.pred.upper <- lp.31$fit + qnorm(p = 1-0.05/2) * lp.31$se

pi.31.pred <- exp(lp.31$fit) / (1+exp(lp.31$fit))
pi.31.lower <- exp(lp.31.lin.pred.lower) / (1+exp(lp.31.lin.pred.lower))
pi.31.upper <- exp(lp.31.lin.pred.upper) / (1+exp(lp.31.lin.pred.upper))

pi.31.pred
pi.31.lower
pi.31.upper
```

# Code 9

```{r}
# bootstrap for 5(e)

bootstrap_coef <- function(data, model, pred_temp) {
  #sample temp with replacement
  sample_temp <- sample(x = data, size = 23, replace = TRUE)
  #find predicted probability
  sample_preds <-predict(object = model, newdata = data.frame(Temp = sample_temp), type = "response")

  #build a dataframe
  df <- data.frame(temp = sample_temp, 
             prob_pred = sample_preds
             )
  
  #map function to find predicted class (fail or not fail)
  df$fail_pred <- unlist(lapply(X = df$prob_pred, FUN = function(x) rbinom(1, 1, x)))
  
  #build glm model
  bootstrap_glm <- glm(formula = fail_pred ~ temp, family = binomial(link=logit), data = df)
  
  #predict probability at pred_temp
  predict(object = bootstrap_glm, newdata = data.frame(temp = pred_temp), type = "response")
}

est_prob_31 <- replicate(10000, bootstrap_coef(d$Temp, m1, 31), simplify = FALSE)

est_prob_72 <- replicate(10000, bootstrap_coef(d$Temp, m1, 72), simplify = FALSE)

quantile(unlist(est_prob_31), c(.05, .95))
quantile(unlist(est_prob_72), c(.05, .95))
```

# Code 10

```{r}
m4 <- glm(formula = Fail ~ Temp + I(Temp^2), family = binomial(link=logit), data = challenger) 
summary(m4)
anova(m1, m4, test='Chisq')
```

